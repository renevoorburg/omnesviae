<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenLayers Map</title>
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.1.0/dist/ol.js"></script>
    <link rel="stylesheet" href="/css/ol.css" type="text/css">
    <style>

        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            /*background-color: #333;*/
            background-color: #b43636;
            color: #fff;
            padding: 0.5em 1em;
            height: 1.3em;
        }

        nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
        }

        nav li {
            margin-right: 15px;
        }

        nav a {
            color: #fff;
            text-decoration: none;
        }

        h1 {
            margin: 0;
            font-size: 1.3em;
            order: 1; /* Set the order to 1 to move it to the right */
        }

        h2 {
            margin: 0.5em 0;
            font-size: 1.2em;
            color: #b43636;
        }

        nav {
            order: 0; /* Set the order to 0 to keep it on the left */
        }

        #map {
            /*flex: 1;*/
            /*box-sizing: border-box;*/
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: calc(100vh - 2.3em);
            z-index: 1;
        }

        #route {
            z-index: 2;
            position: absolute;
            top: 2.8em;
            left: 0.5em;
            width: 280px;
            bottom: 1em;
            background-color: white;
            padding: 1em;
            border-radius: 1em;
            opacity: 0.9;
            border-color: #999;
            border-style: solid;
            border-width: 1px;

            overflow:auto;
        }

        /*#result {*/
        /*    position: absolute;*/
        /*    bottom: 0;*/
        /*    overflow:none;*/
        /*}*/

        input[type="text"] {
            padding: 8px; /* Adjust padding as needed */
            margin-top: 5px;
            border: 1px solid #ccc; /* Optional: Add border for better visibility */
            border-radius: 5px; /* Add rounded corners */
            width: 93%;
        }

        .suggestions {
            display: none;
            position: absolute;
            background-color: #f1f1f1;
            border: 1px solid #d4d4d4;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1;
            width: 88%;
        }

        .suggestion {
            padding: 8px;
            cursor: pointer;
        }

        .suggestion:hover {
            background-color: #ddd;
        }

        .error-text {
            color: #b43636;
        }



        .ol-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #cccccc;
            bottom: 12px;
            left: -50px;
            min-width: 200px;
        }

        .ol-popup-closer {
            text-decoration: none;
            color: #bababc;
            position: absolute;
            top: 2px;
            right: 8px;
            font-size: 18px;
            font-weight: bold;
        }

        .ol-popup-closer:hover {
            color: #b43636;
        }

    </style>
</head>
<body>

<header>
    <h1>OmnesViae</h1>
    <nav>
        <ul>
        <li><a href="#">Iter</a></li>
        <li><a href="#">Tabula</a></li>
        <li><a href="#">De Nobis</a></li>
        </ul>
    </nav>
</header>

<div id="route">
    <h2>Iter vestrum</h2>
    <form action="#" method="get">
        <div class="autocomplete-container">
            <label for="place1">Origo:</label><br>
            <input type="text" id="place1" name="place1" required autocomplete="off"
                   oninput="handleInput(this.value, 'place1', 'place1Value')">
            <div id="suggestions-place1" class="suggestions"></div>
            <input type="hidden" id="place1Value" name="place1Value">
        </div>
        <br>
        <div class="autocomplete-container">
            <label for="place2">Destinatio:</label><br>
            <input type="text" id="place2" name="place2" required autocomplete="off"
                   oninput="handleInput(this.value, 'place2', 'place2Value')">
            <div id="suggestions-place2" class="suggestions"></div>
            <input type="hidden" id="place2Value" name="place2Value">
        </div>
        <br>
        <input type="submit" id="submitBtn" value=" Iter Faciam " disabled>
    </form>
    <div id="results-container"></div>
</div>

<div id="map" class="map"></div>
<div id="popup" class="ol-popup">
    <a href="#" id="popup-closer" class="ol-popup-closer">X</a>
    <div id="popup-content"></div>
</div>

<script>

    function showRouteOnMap(places) {
        const coordinates = places.map(element => getCoordinatesById(element)).filter(coord => coord !== null);
        routeVectorSource.clear();
        if (coordinates.length > 1) {
            const routeLineStringFeature = new ol.Feature({
                geometry: new ol.geom.LineString(coordinates),
            });
            routeVectorSource.addFeature(routeLineStringFeature);
            map.getView().fit(routeLineStringFeature.getGeometry(), {
                padding: [30, 30, 30, 50],
                duration: 1500,
                maxZoom: 12
            });
        }

        const resultBox = document.getElementById("results-container");
        resultBox.innerHTML = '<br><h2>Iter brevissimum</h2>';
        for (const place of places) {
            var placeName = getPropertyById(place, 'name');
            resultBox.innerHTML += `<p>${placeName}</p>`;
        }

    }

    function getPropertyById(id, property) {
        const features = geojson.getSource().getFeatures();
        for (const feature of features) {
            const properties = feature.getProperties();
            if (properties.id === id) {
                return properties[property];
            }
        }
        return null;
    }


    function getCoordinatesById(id) {
        const features = geojson.getSource().getFeatures();
        for (const feature of features) {
            const properties = feature.getProperties();
            if (properties.id === id) {
                const geometry = feature.getGeometry();
                return geometry.getCoordinates();
            }
        }
        return null;
    }

    function getFeatureStyle(feature) {
        const symbol = feature.get('symbol');
        const defaultSymbol = '0';
        const iconPath = `/images/symbols/${symbol ? symbol.charAt(0) : defaultSymbol}.png`;

        let lineColor = 'rgba(180, 54, 54, 1)';
        if (feature.getGeometry().getType() === 'LineString' && feature.get('extrapolated') === true) {
            lineColor = 'rgba(180, 54, 54, 0.5)';
        }
        return new ol.style.Style({
            image: new ol.style.Icon({
                src: iconPath,
                anchor: [0.5, 0.5],
                anchorXUnits: 'fraction',
                anchorYUnits: 'fraction',
                opacity: 1,
                scale: 0.8,
            }),
            stroke: new ol.style.Stroke({
                color: lineColor,
                width: 3,
            }),
        });
    }

    // Overlay to display the popup
    const overlay = new ol.Overlay({
        element: document.getElementById('popup'),
        autoPan: true,
        autoPanAnimation: {
            duration: 250
        }
    });

    const geojson = new ol.layer.Vector({
        source: new ol.source.Vector({
            format: new ol.format.GeoJSON(),
            url: '/api/geofeatures'
        }),
        style: getFeatureStyle,
        zIndex: 2
    });

    // Initialize the map
    const map = new ol.Map({
        target: 'map',
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM() // OpenStreetMap as the tile source
            }),
            geojson
        ],
        overlays: [overlay],
        view: new ol.View({
            center: ol.proj.fromLonLat([12.5, 41.9]), // Center of the map, lon/lat
            zoom: 7.8 // Initial zoom level
        })
    });

    // Create vector source and layer outside showRouteOnMap, so that it's not re-created every time
    const routeVectorSource = new ol.source.Vector();
    const routeVectorLayer = new ol.layer.Vector({
        source: routeVectorSource,
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: 'rgb(255, 255, 0, 0.5)', // Change this to the desired color
                width: 9, // Change this to the desired width
            }),
        }),
        zIndex: 1
    });
    map.addLayer(routeVectorLayer);

    // Popup closer
    const closer = document.getElementById('popup-closer');
    closer.onclick = () => {
        overlay.setPosition(undefined);
        closer.blur();
        return false;
    };

    // Display popup on click
    map.on('click', function (event) {
        const feature = map.forEachFeatureAtPixel(event.pixel, function (feature) {
            return feature;
        });
        if (feature && feature.getGeometry().getType() === 'Point') {
            const coordinates = feature.getGeometry().getCoordinates();
            const content = '<p><b>' + feature.get('name') + '</b></p><p>' + feature.get('description') + '</p>';
            overlay.setPosition(coordinates);
            document.getElementById('popup-content').innerHTML = content;
        } else {
            // If it's not a Point feature, hide the popup
            overlay.setPosition(undefined);
        }
    });

    // Set pointer cursor when hovering over a point feature
    map.on('pointermove', function (event) {
        const pixel = map.getEventPixel(event.originalEvent);
        const feature = map.forEachFeatureAtPixel(pixel, function (feature) {
            return feature;
        });
        if (feature && feature.getGeometry().getType() === 'Point') {
            map.getTargetElement().style.cursor = 'pointer';
        } else {
            map.getTargetElement().style.cursor = '';
        }
    });

</script>

<script>
    // code for the autocomplete and form handling:
    document.addEventListener('DOMContentLoaded', function () {
        const submitBtn = document.getElementById('submitBtn');

        document.addEventListener('click', handleOutsideClick);
        document.querySelector('form').addEventListener('submit', submitForm);

        function handleInput(inputValue, inputId, hiddenFieldId) {
            const suggestionsContainer = document.getElementById(`suggestions-${inputId}`);
            const hiddenField = document.getElementById(hiddenFieldId);
            const inputField = document.getElementById(inputId);

            function handleApiResponse(data) {
                const hasExactMatch = data.some(item => item.exact);

                if (!hasExactMatch) {
                    inputField.classList.add('error-text');
                    hiddenField.value = '';
                } else {
                    const exactMatch = data.find(item => item.exact);
                    hiddenField.value = exactMatch.value;
                    inputField.classList.remove('error-text');
                }

                if (data.length === 1 && hasExactMatch) {
                    suggestionsContainer.style.display = 'none';
                } else if (data.length >= 1) {
                    suggestionsContainer.style.display = 'block';
                    populateSuggestions(data, inputField, hiddenField, suggestionsContainer);
                } else {
                    suggestionsContainer.style.display = 'none';
                }
                updateSubmitButton();
            }

            function populateSuggestions(data) {
                suggestionsContainer.innerHTML = '';

                data.forEach(item => {
                    const suggestionDiv = document.createElement("div");
                    suggestionDiv.classList.add("suggestion");
                    suggestionDiv.textContent = item.label;
                    suggestionDiv.addEventListener("click", () => {
                        inputField.value = item.label;
                        hiddenField.value = item.value;
                        suggestionsContainer.style.display = 'none';
                        inputField.classList.remove('error-text');
                        updateSubmitButton();
                    });
                    suggestionsContainer.appendChild(suggestionDiv);
                });
            }

            function updateSubmitButton() {
                const place1Value = document.getElementById('place1Value').value;
                const place2Value = document.getElementById('place2Value').value;
                submitBtn.disabled = !(place1Value && place2Value);
            }

            // Example fetch call
            fetch(`/api/labels/${inputValue}`)
                .then(response => response.json())
                .then(data => handleApiResponse(data))
                .catch(error => {
                    console.error("Error fetching suggestions:", error);
                    // Handle errors as needed
                });
        }

        function handleOutsideClick(event) {
            // Check if the click was outside the suggestion box and input field
            if (!event.target.closest('.autocomplete-container')) {
                hideSuggestions();
            }
        }

        function hideSuggestions() {
            // Hide suggestion boxes
            document.querySelectorAll('.suggestions').forEach(suggestionsContainer => {
                suggestionsContainer.style.display = 'none';
            });
        }

        function submitForm(event) {
            event.preventDefault();

            const place1Value = document.getElementById('place1Value').value;
            const place2Value = document.getElementById('place2Value').value;

            fetch(`/api/route/${place1Value}/${place2Value}`)
                .then(response => response.json())
                .then(data => showRouteOnMap(data))
                .catch(error => {
                    console.error("Error fetching route:", error);
                })
        }

        window.handleInput = handleInput; // Expose handleInput globally for the oninput attribute in the HTML
    });



</script>

</body>
</html>
