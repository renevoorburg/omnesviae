<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenLayers Map</title>
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.1.0/dist/ol.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.1.0/ol.css" type="text/css">
    <style>
        /* Add your custom styles here */
        #map {
            width: 100%; /* Set your desired width */
            height: 600px; /* Set your desired height */
        }

        .ol-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #cccccc;
            bottom: 12px;
            left: -50px;
            min-width: 200px;
        }

        .ol-popup-closer {
            text-decoration: none;
            color: #bababc;
            position: absolute;
            top: 2px;
            right: 8px;
            font-size: 18px;
            font-weight: bold;
        }

        .ol-popup-closer:hover {
            color: #ff4242;
        }


    </style>
</head>
<body>



<div id="form">

    <form action="#" method="post" onsubmit="submitForm(event)">
        <label for="place1">Place 1:</label>
        <input type="text" id="place1" name="place1" required>

        <br>

        <label for="place2">Place 2:</label>
        <input type="text" id="place2" name="place2" required>

        <br>

        <input type="submit" value="Submit" onclick="testRouteButtonClicked()">
    </form>
</div>

<div id="map" class="map"></div>
<div id="popup" class="ol-popup">
    <a href="#" id="popup-closer" class="ol-popup-closer">X</a>
    <div id="popup-content"></div>
</div>




<!-- Your map initialization script -->
<script>
    function testRouteButtonClicked() {
        var places = ["TPPlace558","TPPlace559", "TPPlace560","TPPlace561"]
        // placesToLineString(["TPPlace558","TPPlace559"])
        getCoordinatesById(places[0])
        var coordinates = places.map(element => getCoordinatesById(element))
        console.log (coordinates)

        const lineStringStyle = new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: 'red', // Change this to the desired color
                width: 3,      // Change this to the desired width
            }),
        });

        const routeLineStringFeature = new ol.Feature({
            geometry: new ol.geom.LineString(coordinates),
        });

// Add the LineString feature to a vector source
        const vectorSource = new ol.source.Vector({
            features: [routeLineStringFeature],
        });

// Create a vector layer
        const vectorLayer = new ol.layer.Vector({
            source: vectorSource,
            style: new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'rgb(255,255,0, 0.5)', // Change this to the desired color
                    width: 9,      // Change this to the desired width
                }),
            }),
            zIndex: 1
        });

// Add the vector layer to the map
        map.addLayer(vectorLayer);

        map.getView().fit(routeLineStringFeature.getGeometry(), {
            padding: [30, 30, 30, 30],
            duration: 1500,
            maxZoom: 10
        });

    }


    function getCoordinatesById(id) {
        const features = geojson.getSource().getFeatures();
        for (const feature of features) {
            const properties = feature.getProperties();
            if (properties.id === id) {
                const geometry = feature.getGeometry();
                return geometry.getCoordinates();
            }
        }
        return null;
    }

    function getStyle(feature) {
        const symbol = feature.get('symbol');
        const defaultSymbol = '0';
        const iconPath = `http://novo.local/images/symbols/${symbol ? symbol.charAt(0) : defaultSymbol}.png`;

        let lineColor = 'red';
        if (feature.getGeometry().getType() === 'LineString' && feature.get('extrapolated') === true) {
            lineColor = 'rgba(255, 0, 0, 0.5)';
        }

        return new ol.style.Style({
            image: new ol.style.Icon({
                src: iconPath,
                anchor: [0.5, 0.5],
                anchorXUnits: 'fraction',
                anchorYUnits: 'fraction',
                opacity: 1,
                scale: 0.8,
            }),
            stroke: new ol.style.Stroke({
                color: lineColor,
                width: 3,
            }),
        });
    }

    // Overlay to display the popup
    var overlay = new ol.Overlay({
        element: document.getElementById('popup'),
        autoPan: true,
        autoPanAnimation: {
            duration: 250
        }
    });


    var geojson = new ol.layer.Vector({
        source: new ol.source.Vector({
            format: new ol.format.GeoJSON(),
            url: 'http://novo.local/api/geofeatures'
        }),
        style: getStyle,
        zIndex: 2
    });

    // Initialize the map
    var map = new ol.Map({
        target: 'map',
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM() // OpenStreetMap as the tile source
            }),
            geojson
        ],
        overlays: [overlay],
        view: new ol.View({
            center: ol.proj.fromLonLat([0, 0]), // Center of the map, lon/lat
            zoom: 2 // Initial zoom level
        })
    });

    // Popup closer
    const closer = document.getElementById('popup-closer');
    closer.onclick = () => {
        overlay.setPosition(undefined);
        closer.blur();
        return false;
    };

    // Display popup on click
    map.on('click', function (event) {
        var feature = map.forEachFeatureAtPixel(event.pixel, function (feature) {
            return feature;
        });

        if (feature && feature.getGeometry().getType() === 'Point') {
            var coordinates = feature.getGeometry().getCoordinates();
            var content = '<p><b>' + feature.get('name') + '</b></p><p>' + feature.get('description') + '</p>';
            overlay.setPosition(coordinates);
            document.getElementById('popup-content').innerHTML = content;
        } else {
            // If it's not a Point feature, hide the popup
            overlay.setPosition(undefined);
        }
    });

    map.on('pointermove', function (event) {
        var pixel = map.getEventPixel(event.originalEvent);

        // Check if there's a feature at the moved pixel
        var feature = map.forEachFeatureAtPixel(pixel, function (feature) {
            return feature;
        });

        // If a feature is found, change the mouse pointer
        if (feature && feature.getGeometry().getType() === 'Point') {
            map.getTargetElement().style.cursor = 'pointer';
        } else {
            map.getTargetElement().style.cursor = '';
        }
    });

</script>
</body>
</html>
